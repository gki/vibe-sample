# テスト

このドキュメントには、プロジェクトのテスト方針について記載します。

## テストフレームワーク

- **Vitest**を使用（フロントエンド・バックエンド共通）
- **Playwright**を使用（E2Eテスト）

## テストの種類と定義

### 静的コードチェック（Lint）

ESLintによる静的コードチェックをテストの1つとして位置づけます。コードスタイル、未使用コード、型安全性、潜在的なバグを検出します。

### 単体テスト（Unit Test）

関数、コンポーネント、リゾルバーなどの個別の単位をテストします。モックを使用して依存関係を分離し、独立してテストできるようにします。

### 統合テスト（Integration Test）

複数のコンポーネントやモジュールが連携して動作することをテストします。APIエンドポイント、GraphQLクエリ/ミューテーションなど、実際のデータベースやAPIを使用してテストします。

### E2Eテスト（End-to-End Test）

Playwrightを使用したブラウザベースのテストです。ユーザーの視点で実際の操作フローをテストし、システム全体の動作を検証します。

## 各テスト種類の実装ルール

### 静的コードチェック

- ESLintルールに準拠
- コミット前に実行（`pnpm lint`）
- knipによる未使用コード・依存関係の検出

### 単体テスト

- モックを使用して依存関係を分離
- AAAパターン（Arrange、Act、Assert）に従う
- 1つの関数、1つのメソッドなど、小さな単位でテストを書く

### 統合テスト

- 実際のデータベースやAPIを使用
- テスト前後のクリーンアップを実施
- 複数のコンポーネントやモジュールの連携を検証

### E2Eテスト

- Playwrightを使用
- 実際のブラウザ環境で実行
- テストデータの管理方法を定義
- ユーザーフロー単位でテストを作成

## 各テスト種類でカバーすべきテスト観点

### 静的コードチェック

- **コードスタイル**: ESLintルール違反の検出
- **未使用コード**: knipによる未使用コードの検出
- **型安全性**: TypeScriptの型チェック
- **潜在的なバグ**: 静的解析による問題の早期発見

**具体例**:
- ESLintルール違反の検出（未使用変数、インポートなど）
- knipによる未使用コードの検出
- 型安全性の確認（`any`型の使用回避など）

### 単体テスト

- **正常系**: 期待される入力に対する正常な動作
- **異常系**: エラーケースや不正な入力に対する処理
- **境界値**: 最小値、最大値、境界付近の値
- **エッジケース**: 特殊な条件や想定外の入力

**具体例**:
- バリデーション関数のテスト（空文字、100文字超、改行文字、タブ文字など）
- コンポーネントのレンダリングテスト（ローディング状態、エラー状態、空状態など）
- リゾルバーの個別機能テスト（バリデーション、エラーハンドリングなど）

### 統合テスト

- **APIエンドポイントの動作**: GraphQLクエリ/ミューテーションの実行
- **データベース操作**: CRUD操作の検証
- **エラーハンドリング**: エラー時の適切な処理

**具体例**:
- GraphQLリゾルバーのCRUD操作テスト（作成、取得、更新、削除）
- データベースとの連携テスト（Prismaクライアントを使用）
- エラーケースの検証（バリデーションエラー、データベースエラーなど）

### E2Eテスト

- **ユーザーフローの完全性**: エンドツーエンドの操作フロー
- **UI操作の連携**: 複数の画面やコンポーネントの連携
- **ブラウザ互換性**: 異なるブラウザでの動作確認

**具体例**:
- TODO作成から削除までの一連の流れ
- フォーム入力から送信、結果表示までのフロー
- エラー時の表示とリカバリー処理

## テストの優先順位と実行環境

### 優先順位

**静的コードチェック（Lint） > 単体テスト > 統合テスト > E2Eテスト**

静的コードチェック（Lint）は、unit testよりも前の段階で実施します。ESLintによる静的コードチェックをテストの1つとして位置づけ、コード品質の基盤を確保します。

### E2Eテストの実行環境

- **ローカル開発環境**: 開発中に手動で実行
- **CI/CDパイプライン**: プルリクエストやマージ時に自動実行

### E2Eテストの対象範囲

全機能を網羅しますが、unit test/integration testでカバーされている範囲はテストしません。E2Eテストは、ユーザーフローの完全性とUI操作の連携に焦点を当てます。

### リファクタリング方針

統合テストやE2Eテストが増えてきた場合は、より前段のテスト（単体テストや統合テスト）にテスト内容を移行することで、unit testとintegration testを中心に検証できるようリファクタリングします。これにより、テストの実行速度向上と保守性の向上を図ります。

## テスト実装のルール

### 単体テスト（Unit Test）の実装ルール

- **格納フォルダ**: テストファイルは対象ファイルと同じディレクトリに配置
  - 例: `src/todo.ts` → `src/todo.test.ts`
- **ファイル名**: 対象ファイル名に`.test.ts`または`.test.tsx`を付与
  - 例: `todo.ts` → `todo.test.ts`
  - 例: `TodoList.tsx` → `TodoList.test.tsx`
- **作成単位**: 1つのプロダクションコードファイルに対して1つのテストファイルを作成
- **テスト構造**: AAAパターン（Arrange、Act、Assert）に従う
- **テスト用helper関数**: `__tests__/helpers/`ディレクトリに配置
  - 例: `__tests__/helpers/test-utils.ts`

### 統合テスト（Integration Test）の実装ルール

- **格納フォルダ**: テストファイルは対象ファイルと同じディレクトリに配置
- **ファイル名**: 対象ファイル名に`.integration.test.ts`を付与
  - 例: `resolvers.ts` → `resolvers.integration.test.ts`
- **作成単位**: 統合テストが必要な機能単位で作成
  - 例: GraphQLリゾルバーのCRUD操作を1つのファイルでテスト
- **テスト環境**: 実際のデータベースやAPIを使用、テスト前後のクリーンアップを実施
- **テスト用helper関数**: `__tests__/helpers/`ディレクトリに配置
  - 例: `__tests__/helpers/db-utils.ts`

### E2Eテスト（End-to-End Test）の実装ルール

- **格納フォルダ**: プロジェクトルートに`e2e/`ディレクトリを作成
- **ファイル名**: 機能名やユーザーフロー名を反映し、`.test.ts`を付与
  - 例: `todo-crud.test.ts`
  - 例: `todo-create-flow.test.ts`
- **作成単位**: ユーザーフロー単位で作成
  - 例: TODO作成から削除までの一連の流れを1つのファイルでテスト
- **ディレクトリ構造**: 機能ごとにディレクトリを分割
  - 例: `e2e/todo/`、`e2e/auth/`
- **テスト用helper関数**: `e2e/helpers/`ディレクトリに配置
  - 例: `e2e/helpers/test-data.ts`
  - 例: `e2e/helpers/page-objects.ts`

## テストの構造（AAAパターン）

```typescript
describe('関数名またはコンポーネント名', () => {
  it('期待する振る舞いを説明', () => {
    // Arrange（準備）: テストデータやモックの準備
    const input = 'test data';
    
    // Act（実行）: テスト対象の実行
    const result = functionToTest(input);
    
    // Assert（検証）: 結果の検証
    expect(result).toBe(expectedValue);
  });
});
```

## テストタイトルの命名規則

- **言語**: テストタイトル（`it`の第1引数）は日本語で記述する
- **形式**: 「〜すること」で終わる形式を推奨（例: 「TODOを作成できること」「エラーが発生すること」）
- **明確性**: テストの意図が明確に分かるように記述する
- **一貫性**: プロジェクト全体で統一された命名規則を適用する

## テスト実行

- **開発中**: `pnpm test`（ウォッチモード）- TDDサイクル中は常に実行（詳細は[tdd-process.md](./tdd-process.md)を参照）
- **コミット前**: `pnpm test` - 全テストが通ることを確認
- **カバレッジ確認**: `pnpm test:coverage`
- **静的コードチェック**: `pnpm lint` - コミット前に実行

## TDDにおけるテストの原則

1. **テストは明確に**: テスト名は何をテストしているか明確に
2. **1つのテスト、1つのアサーション**: 1つのテストで1つのことを検証
3. **独立性**: テストは互いに依存しない（実行順序に依存しない）
4. **再現性**: 同じ条件下で常に同じ結果になる
5. **冪等性**: 繰り返し実施しても同じ結果を返す（特に統合テスト・E2Eテストでは重要）

## カバレッジ目標

- TDDで実装した部分: 高いカバレッジが自然に達成される
- 初期実装: 60%以上
- 本番リリース前: 80%以上（推奨）

**注意**: カバレッジは目標であり、TDDの目的ではない。TDDの目的は「動作する仕様」を作ること。

